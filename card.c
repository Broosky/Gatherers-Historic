/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Program Name: Gatherers (C)                                                                                            //
//  Author: Jeffrey Bednar                                                                                                 //
//  Copyright: Illusion Interactive, 2011                                                                                  //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#ifndef _CARD_C_
#define _CARD_C_
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "main.h"
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl CARD_Zero(CARD* p_Card) {
    ZeroMemory(p_Card, sizeof(CARD));
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CARD* __cdecl CARD_Create(GLOBALS* p_Globals, IMAGES* p_Images) {
    CARD* p_Card = (CARD*)malloc(sizeof(CARD));
    (*p_Globals).iRunningHeap += sizeof(CARD);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    CARD_Zero(p_Card);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    (*p_Card).iState = CARD_BLANK;
    (*p_Card).p_Picture = &(*p_Images).Card[0];
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    return p_Card;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl CARD_Kill(CARD* p_Card, GLOBALS* p_Globals) {
    free(p_Card);
    (*p_Globals).iRunningHeap -= sizeof(CARD);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl CARD_EvaluateSelected(CARD* p_Card, GLOBALS* p_Globals, IMAGES* p_Images) {
    int iStructureCount = 0;
    int iWorkerCount = 0;
    ENTITY* p_Current = (*p_Globals).p_RootEntity;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    while(p_Current) {
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Keep track of how many structures are selected.
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        if((*p_Current).bIsSelected && (*p_Current).iType == ENTITY_COMMAND) {
            iStructureCount++;
        }
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Keep track of how many movable entities are selected.
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        if((*p_Current).bIsSelected && (*p_Current).bIsMovable) {
            iWorkerCount++;
        }
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        p_Current = (ENTITY*)(*p_Current).p_Next;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Display the correct command card for what was evaluated.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // We have selected one worker. (Allow the worker to build something.)
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if(iWorkerCount == 1) {
        (*p_Card).p_Picture = &(*p_Images).Card[3];
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // We have selected multiple workers. (Only allow move and stop.)
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    else if(iWorkerCount > 1) {
        (*p_Card).p_Picture = &(*p_Images).Card[1];
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // We have selected one structure. (Allow the building to create something.)
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    else if(iStructureCount == 1) {
        (*p_Card).p_Picture = &(*p_Images).Card[2];
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // We have selected multiple structures. (Do not allow anything at all.)
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    else if(iStructureCount > 1) {
        (*p_Card).p_Picture = &(*p_Images).Card[0];
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // We have selected nothing of importance.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    else {
        (*p_Card).p_Picture = &(*p_Images).Card[0];
    }
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#endif
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
